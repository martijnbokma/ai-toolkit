# Project Context

## Overview

ai-toolkit is a universal CLI tool that syncs AI editor configurations (rules, skills, workflows) from a single source of truth (`.ai-content/`) to **14 AI editors** simultaneously. It eliminates the need to manually maintain separate config files for each editor.

**Author**: Martijn Bokma
**Status**: v0.1.0 — feature-complete, preparing for npm publish

## Architecture

The project follows a **plugin-based adapter pattern**:

1. **Config loader** — Parses `ai-toolkit.yaml` with Zod validation
2. **Editor adapters** — Each editor has an adapter (extends `BaseEditorAdapter`) that knows its directory structure, file naming, frontmatter format, entry point, and MCP config path
3. **Syncer pipeline** — Orchestrates the full sync: content resolution → merge external sources → sync to editors → overrides → entry points → MCP configs → editor settings → orphan detection → .gitignore
4. **CLI layer** — Commander-based CLI with commands: `init`, `sync`, `validate`, `watch`, `sync-all`, `promote`

### Key Design Decisions

- **YAML config** (`ai-toolkit.yaml`) as the single config file — human-readable, easy to diff
- **`.ai-content/`** as the content SSOT directory — rules, skills, workflows, overrides, PROJECT.md
- **Auto-generated marker** (`<!-- ⚠️ AUTO-GENERATED by ai-toolkit — DO NOT EDIT -->`) in all generated files
- **Source markers** (`<!-- Source: ... -->`) for traceability back to SSOT
- **Template inheritance** via `extends` — stack templates provide defaults that project config overrides
- **Custom editors** via `custom_editors` in YAML — plugin system for unsupported editors
- **Content sources** — external local/package sources that merge with local `.ai-content/`

## Tech Stack

- **Language**: TypeScript (strict mode, ES2022 target)
- **Runtime**: Bun (package manager + test runner)
- **Build**: tsup (dual entry: CLI with shebang + library with .d.ts)
- **Validation**: Zod v4 (config schema validation)
- **CLI**: Commander v14 (argument parsing)
- **UI**: chalk (colors), ora (spinners), @clack/prompts (interactive init)
- **Testing**: Vitest v4
- **Config format**: YAML (js-yaml)

## Directory Structure

```
src/
├── cli/                    # CLI commands (commander actions)
│   ├── index.ts            # Program definition, command registration
│   ├── init.ts             # `init` command — scaffolds config + .ai-content/
│   ├── sync.ts             # `sync` command — runs syncer + displays results
│   ├── validate.ts         # `validate` command — checks config + content
│   ├── watch.ts            # `watch` command — fs.watch on .ai-content/ + yaml
│   ├── sync-all.ts         # `sync-all` command — monorepo support
│   └── promote.ts          # `promote` command — promote local content to SSOT
├── core/                   # Core types and config
│   ├── types.ts            # Zod schemas, TypeScript types, constants
│   └── config-loader.ts    # YAML parsing, Zod validation, template merging
├── editors/                # Editor adapter plugins
│   ├── base-adapter.ts     # Abstract base class for all adapters
│   ├── registry.ts         # Adapter registry, getEnabledAdapters(), custom editor builder
│   ├── cursor.ts           # Cursor adapter
│   ├── windsurf.ts         # Windsurf adapter
│   ├── claude.ts           # Claude Code adapter
│   └── ... (14 adapters)   # One file per editor
├── sync/                   # Sync engine
│   ├── syncer.ts           # Main sync orchestrator (runSync)
│   ├── content-resolver.ts # Resolves external content sources
│   ├── entry-points.ts     # Generates entry point files (.cursorrules, CLAUDE.md, etc.)
│   ├── mcp-generator.ts    # Generates MCP server configs per editor
│   ├── settings-syncer.ts  # Generates .editorconfig + .vscode/settings.json
│   ├── cleanup.ts          # Detects orphaned auto-generated files
│   ├── gitignore.ts        # Auto-updates .gitignore with generated paths
│   ├── ssot-detector.ts    # Detects SSOT orphans and diffs
│   ├── auto-promoter.ts    # Auto-promotes new local content to SSOT
│   ├── monorepo.ts         # Finds nested ai-toolkit.yaml files
│   └── project-context.ts  # Reads PROJECT.md and appends to entry points
├── utils/                  # Shared utilities
│   ├── file-ops.ts         # File I/O helpers (read, write, find markdown files)
│   ├── logger.ts           # Colored logging (log.info, log.synced, log.dryRun, etc.)
│   ├── git-hooks.ts        # Git hook installation helpers
│   └── package-scripts.ts  # package.json script injection helpers
├── index.ts                # Library entry point (public API exports)
templates/                  # Built-in templates (shipped with npm package)
├── project-context.md      # PROJECT.md template
├── rules/                  # Default rule templates
├── skills/                 # Built-in skill templates
├── stacks/                 # Stack templates (nextjs, react, python-api, etc.)
└── workflows/              # Workflow templates
tests/                      # Vitest test suites
```

## Conventions

- All editor adapters extend `BaseEditorAdapter` and are registered in `registry.ts`
- Generated files always include `AUTO_GENERATED_MARKER` as first line
- Content flows one-way: `.ai-content/` → editor directories (never reverse)
- Overrides in `.ai-content/overrides/<editor>/` replace shared content for that editor
- File naming: adapters declare `flat` (filename.md) or `subdirectory` (name/SKILL.md)
- Imports use `.js` extensions (ESM compatibility)
- No default exports — all exports are named

## Key Dependencies

| Dependency | Purpose |
|------------|---------|
| zod v4 | Config schema validation with detailed error messages |
| commander v14 | CLI argument parsing and command registration |
| chalk v5 | Terminal color output |
| ora v9 | Spinner animations during sync |
| @clack/prompts | Interactive prompts during `init` |
| js-yaml v4 | YAML parsing for ai-toolkit.yaml |
| tsup v8 | Build tool — dual entry (CLI + library), DTS generation |
| vitest v4 | Test runner |

## Development

- **Dev**: `bun run dev` (tsup --watch)
- **Build**: `bun run build` (tsup → dist/cli.js + dist/index.js + dist/index.d.ts)
- **Test**: `bun run test:run` (vitest run — 20+ tests, 3 suites)
- **Typecheck**: `bun run typecheck` (tsc --noEmit)
- **Run locally**: `bun src/cli/index.ts <command>`

## PR & Commit Conventions

- **Commit format**: conventional commits (feat:, fix:, refactor:, test:, docs:)
- **Pre-publish checks**: typecheck → test → build (via prepublishOnly)

## Security

- No API keys or secrets in this project
- Generated files should never contain sensitive data
- `.gitignore` auto-management prevents accidental commits of generated files

## Notes

- **Zod v4 quirk**: Avoid explicit type annotations on Zod error `.map()` callbacks — `$ZodIssue.path` uses `PropertyKey[]` (includes symbol) which conflicts with manual `(string | number)[]` annotations. Let TypeScript infer instead.
- **tsup dual entry**: CLI entry gets `#!/usr/bin/env node` banner, library entry gets DTS generation. These are separate tsup configs in an array.
- **Template inheritance**: `extends` in YAML loads templates from `templates/stacks/`, deep-merges with project config (project wins).
- The `templates/` directory is included in the npm package (`files` field in package.json) so users get built-in templates.
